# v2 Schema

v2 adds **nested containers**, explicit **container kinds**, and the `interactions:` alias for relations. v1 files remain fully valid — no migration is required.

### What's New in v2

| Feature | Description |
|---------|-------------|
| `kind` | Required on every container: `service`, `module`, or `library` |
| `contains` | Nest child containers inside a parent |
| `interactions` | Alias for `relations` (both accepted) |
| Dot-qualified IDs | Nested containers get IDs like `billing-service.invoice-module` |
| Context inheritance | Children inherit parent's `context` unless they override it |

### File Format (v2)

```yaml
version: 2

system:
  id: my-platform
  name: My Platform

contexts:
  billing:
    name: Billing Context

containers:
  billing-service:
    kind: service
    name: Billing Service
    context: billing
    code:
      roots: [services/billing]
      layers:
        api: [services/billing/api/**]
        domain: [services/billing/domain/**]
    contains:
      invoice-module:
        kind: module
        name: Invoice Module
        code:
          roots: [services/billing/domain/invoice]
          layers:
            model: [services/billing/domain/invoice/model/**]
            repo: [services/billing/domain/invoice/repo/**]

  shared-utils:
    kind: library
    name: Shared Utilities
    code:
      roots: [libs/shared]

interactions:
  - from: billing-service
    to: shared-utils
    protocol: import
```

### Schema Reference (v2)

v2 containers extend the v1 schema with these additional fields:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `kind` | string | **Yes** | `service`, `module`, or `library` |
| `contains` | map | No | Nested child containers (same schema, recursive) |

All v1 container fields (`name`, `description`, `context`, `code`, `tags`) remain unchanged.

### Container Kinds

| Kind | Meaning |
|------|---------|
| `service` | Deployable service or application |
| `module` | Logical module within a service |
| `library` | Shared library used by other containers |

### Enriched Fields: `kind` vs `within`

When code is analyzed, each node and edge is enriched with container metadata. For nested containers, there are two important fields:

| Field | Meaning | Example Value |
|-------|---------|---------------|
| `kind` | Immediate container's kind | `module` for code in `billing-service.invoice-module` |
| `within` | Top-level container's kind | `service` for any code inside `billing-service` |

**Example:** For code at `services/billing/domain/invoice/model/invoice.py`:

```
billing-service (kind: service)
└── invoice-module (kind: module)
    └── model/invoice.py  ← this file
```

The enriched fields would be:

| Field | Value |
|-------|-------|
| `container` | `billing-service.invoice-module` |
| `service` | `billing-service` |
| `kind` | `module` |
| `within` | `service` |

**When to use each in rules:**

- Use `kind` to match the specific container type (e.g., target only code directly in modules)
- Use `within` to match anything inside a service hierarchy (e.g., catch all service code, including nested modules)

See [Rules DSL: kind vs within](../rules.md#kind-vs-within) for detailed examples.

### Dot-Qualified IDs

Nested containers are addressed using dot-qualified IDs. For the example above:

- `billing-service` — the top-level service
- `billing-service.invoice-module` — the nested module

These IDs are used in `interactions`, rules, and enrichment output.

### Context Inheritance

Children inherit their parent's `context:` unless they explicitly set their own:

```yaml
containers:
  billing-service:
    kind: service
    context: billing          # set here
    contains:
      invoice-module:
        kind: module          # inherits context: billing
      payments-module:
        kind: module
        context: payments     # overrides with own context
```

### Version Detection

| `version:` value | Behavior |
|------------------|----------|
| absent | v1 (default) |
| `1` | v1 |
| `2` | v2 — `kind` required, `contains` and `interactions` supported |
| anything else | Error |

### v1 → v2 Key Mapping

| v1 key | v2 key | Notes |
|--------|--------|-------|
| `context:` | `context:` | Unchanged |
| `relations:` | `interactions:` | Both accepted in v2; `relations:` takes precedence if both present |
| _(n/a)_ | `contains:` | New in v2 |
| _(n/a)_ | `kind:` | Required in v2 |
